# ë°ì´í„° ì „ì²˜ë¦¬ ë° ì˜ˆì¸¡ íŒŒì´í”„ë¼ì¸ ì›Œí¬í”Œë¡œìš°

## ğŸ“‹ ì „ì²´ í”„ë¡œì„¸ìŠ¤

### Step 1: ì›ë³¸ ì—‘ì…€ êµ¬ì¡° í™•ì¸

```bash
python inspect_excel.py
```

ì—‘ì…€ íŒŒì¼ì— `price`ì™€ `volume` ì‹œíŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

**ì˜ˆìƒ êµ¬ì¡°:**
- **price ì‹œíŠ¸**: ì²« ë²ˆì§¸ ì»¬ëŸ¼=ë‚ ì§œ, ë‚˜ë¨¸ì§€=ì¢…ëª©ì½”ë“œ, ê°’=ì¢…ê°€
- **volume ì‹œíŠ¸**: ì²« ë²ˆì§¸ ì»¬ëŸ¼=ë‚ ì§œ, ë‚˜ë¨¸ì§€=ì¢…ëª©ì½”ë“œ, ê°’=ê±°ë˜ëŸ‰

```
price ì‹œíŠ¸ ì˜ˆì‹œ:
date       | 005930 | 000660 | 035420
2024-01-02 | 70000  | 200000 | 55000
2024-01-03 | 71000  | 205000 | 56000
...

volume ì‹œíŠ¸ ì˜ˆì‹œ:
date       | 005930  | 000660  | 035420
2024-01-02 | 1000000 | 500000  | 800000
2024-01-03 | 1200000 | 550000  | 850000
...
```

---

### Step 2: ë°ì´í„° ì „ì²˜ë¦¬ ë° ì—‘ì…€ ì €ì¥ â­

```bash
python preprocess_excel_data.py
```

ì´ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆ˜í–‰í•˜ëŠ” ì‘ì—…:

1. **ì—‘ì…€ ì½ê¸°**
   - `price` ì‹œíŠ¸: ê°€ê²© ë°ì´í„°
   - `volume` ì‹œíŠ¸: ê±°ë˜ëŸ‰ ë°ì´í„°

2. **í˜•íƒœ ë³€í™˜**
   - [ë‚ ì§œ Ã— ì¢…ëª©ì½”ë“œ] â†’ [date, symbol, close/volume]
   - `melt()` í•¨ìˆ˜ ì‚¬ìš©

3. **ë°ì´í„° ë³‘í•©**
   - `(date, symbol, close)` + `(date, symbol, volume)` 
   - â†’ `(date, symbol, close, volume)`

4. **íŠ¹ì„± ì—”ì§€ë‹ˆì–´ë§**
   - `log_return`: ë¡œê·¸ ìˆ˜ìµë¥ 
   - `vol_z`: ê±°ë˜ëŸ‰ z-score (60ì¼ ê¸°ì¤€)
   - `volatility20`: 20ì¼ ì´ë™í‰ê·  ë³€ë™ì„±
   - `mom20`: 20ì¼ ëˆ„ì  ìˆ˜ìµë¥ 

5. **ì—‘ì…€ ì €ì¥**
   - `preprocessed_data.xlsx` ìƒì„±
   - **ì‹œíŠ¸ êµ¬ì„±:**
     - `data`: ë©”ì¸ ë°ì´í„° (ì „ì²˜ë¦¬ëœ ëª¨ë“  í•„ë“œ)
     - `ì „ì²´_í†µê³„`: ê¸°ë³¸ í†µê³„ ì •ë³´
     - `ê²°ì¸¡ì¹˜_í†µê³„`: ê²°ì¸¡ì¹˜ ë¶„ì„
     - `ì¢…ëª©ë³„_í†µê³„`: ì¢…ëª©ë³„ ìƒì„¸ í†µê³„

**ì¶œë ¥ íŒŒì¼:** `preprocessed_data.xlsx`

---

### Step 3: ëª¨ë¸ í•™ìŠµ

```bash
python temporal_gat_monthly_ensemble_pipeline.py --mode train --asof 2024-09-30
```

**ì‘ì—… ë‚´ìš©:**
1. `preprocessed_data.xlsx` ìë™ ë¡œë“œ
2. ì „ì²˜ë¦¬ëœ íŠ¹ì„± ì‚¬ìš©
3. ì›”ë§ ê¸°ì¤€ ëª¨ë¸ í•™ìŠµ (T=20, 40, 60)
4. ëª¨ë¸ ì €ì¥: `models/model_T{T}_{YYYYMMDD}.joblib`

**ì¶œë ¥:**
- `models/model_T20_20240930.joblib`
- `models/model_T40_20240930.joblib`
- `models/model_T60_20240930.joblib`

---

### Step 4: ì˜ˆì¸¡ ì‹¤í–‰

```bash
python temporal_gat_monthly_ensemble_pipeline.py --mode predict --asof 2024-09-30
```

**ì‘ì—… ë‚´ìš©:**
1. í•™ìŠµëœ ëª¨ë¸ 3ê°œ ë¡œë“œ
2. ê° ëª¨ë¸ë¡œ ì˜ˆì¸¡ ìˆ˜í–‰
3. ì•™ìƒë¸” (í‰ê·  í™•ë¥ )
4. ê²°ê³¼ë¥¼ ì—‘ì…€ë¡œ ì €ì¥

**ì¶œë ¥ íŒŒì¼:** `output/pred_matrix_20240930.xlsx`

**ì‹œíŠ¸ ë‚´ìš©:**
- `proba_ens_0`, `proba_ens_1`, `proba_ens_2`: ì•™ìƒë¸” ì˜ˆì¸¡ í™•ë¥ 
- `pred_ensemble`: ì•™ìƒë¸” ì˜ˆì¸¡ í´ë˜ìŠ¤
- `proba_T20/40/60_0/1/2`: ê° ëª¨ë¸ë³„ í™•ë¥ 
- `pred_T20/40/60`: ê° ëª¨ë¸ë³„ ì˜ˆì¸¡

---

## ğŸ”„ ì „ì²´ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ price_volume_timeseries.xlsx â”‚
â”‚  (ì›ë³¸ í–‰ë ¬ í˜•íƒœ)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ preprocess_excel_data.py
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  preprocessed_data.xlsx              â”‚
â”‚  - data ì‹œíŠ¸ (ê¸´ í˜•íƒœ + íŠ¹ì„±)         â”‚
â”‚  - í†µê³„ ì‹œíŠ¸                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ temporal_gat_monthly_ensemble_pipeline.py
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â†“                 â†“
â”€trainâ”€          â”€predictâ”€
    â”‚                 â”‚
    â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚modelsâ”‚      â”‚ pred_matrix   â”‚
â”‚.joblibâ”‚      â”‚ .xlsx         â”‚
â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ì£¼ìš” í•¨ìˆ˜ ì„¤ëª…

### `load_and_engineer()`

ë‘ ê°€ì§€ í˜•ì‹ì„ ìë™ ê°ì§€í•˜ì—¬ ì²˜ë¦¬:

1. **ì „ì²˜ë¦¬ëœ íŒŒì¼**: `data` ì‹œíŠ¸ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ë¡œë“œ
2. **ì›ë³¸ íŒŒì¼**: `price`, `volume` ì‹œíŠ¸ë¥¼ ì½ì–´ ë³€í™˜

```python
# ì „ì²˜ë¦¬ëœ íŒŒì¼ ìš°ì„  ì‚¬ìš©
if "data" in sheet_names:
    return pd.read_excel(data_path, sheet_name="data")
else:
    # ì›ë³¸ íŒŒì¼ ì²˜ë¦¬
    price = pd.read_excel(data_path, sheet_name="price").melt(...)
    volume = pd.read_excel(data_path, sheet_name="volume").melt(...)
    return pd.merge(price, volume, ...)
```

### ì „ì²˜ë¦¬ íŠ¹ì„±

- `log_return`: `log(pct_change() + 1)` (ë¡œê·¸ ìˆ˜ìµë¥ )
- `vol_z`: `(volume - mean_60d) / std_60d` (ê±°ë˜ëŸ‰ í‘œì¤€í™”)
- `volatility20`: `std(log_return, 20)` (20ì¼ ë³€ë™ì„±)
- `mom20`: `sum(log_return, 20)` (20ì¼ ëª¨ë©˜í…€)

---

## ğŸ¯ ì‚¬ìš© ì˜ˆì‹œ

```bash
# 1. ì—‘ì…€ êµ¬ì¡° í™•ì¸
python inspect_excel.py

# 2. ì „ì²˜ë¦¬ (ì—‘ì…€ë¡œ ì €ì¥)
python preprocess_excel_data.py

# 3. ëª¨ë¸ í•™ìŠµ
python temporal_gat_monthly_ensemble_pipeline.py --mode train --asof 2024-09-30

# 4. ì˜ˆì¸¡
python temporal_gat_monthly_ensemble_pipeline.py --mode predict --asof 2024-09-30
```

ëª¨ë‘ ì™„ë£Œí•˜ë©´:
- âœ… `preprocessed_data.xlsx` (ì „ì²˜ë¦¬ëœ ë°ì´í„°)
- âœ… `models/` (í•™ìŠµëœ ëª¨ë¸ë“¤)
- âœ… `output/pred_matrix_YYYYMMDD.xlsx` (ì˜ˆì¸¡ ê²°ê³¼)

