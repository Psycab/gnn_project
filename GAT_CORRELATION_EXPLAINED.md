# GAT에서 상관관계 사용법

## 핵심 개념

### GAT (Graph Attention Network)

```
그래프 = 노드(종목) + 엣지(종목 간 연결)

상관관계 = 엣지 연결의 기준
```

## 실제 사용 예시

```
한 월말(예: 2021-04-30)에 대해:

종목들: 삼성전자, SK하이닉스, LG전자, 현대차, 카카오, ...

1. 각 종목의 20일 수익률 데이터:
   삼성전자: [수익률1, 수익률2, ..., 수익률20]
   SK하이닉스: [수익률1, 수익률2, ..., 수익률20]
   ...

2. 상관관계 계산:
   corr(삼성전자, SK하이닉스) = 0.85  ← 높은 상관관계!
   corr(삼성전자, 카카오) = 0.12     ← 낮은 상관관계
   corr(SK하이닉스, LG전자) = 0.78   ← 높은 상관관계

3. 그래프 구성:
   threshold = 0.3
   
   삼성전자 ←→ SK하이닉스  (0.85 > 0.3 ✓)
   삼성전자 ❌ 카카오      (0.12 < 0.3 ✗)
   SK하이닉스 ←→ LG전자    (0.78 > 0.3 ✓)

4. GAT 처리:
   - 삼성전자가 SK하이닉스의 정보를 받아서
     자기 예측을 더 정확하게 함
   - 카카오는 상관관계 낮아서 연결 안됨
   - 반도체 관련 종목들은 서로 연결되어
     강한 그룹으로 학습
```

## 왜 상관관계가 필요한가?

### 시계열 데이터의 독립 처리 (GRU/LSTM)
```
종목1: [시계열] → 모델 → 예측1
종목2: [시계열] → 모델 → 예측2
```
- 각 종목을 독립적으로 처리
- 같은 산업/그룹이어도 정보 공유 안됨

### GAT로 종목 간 정보 공유
```
종목1 ←→ 종목2 (상관관계로 연결)
종목1 ←→ 종목3

종목1의 예측에 종목2, 종목3의 정보가 반영됨!
```
- 상관관계가 높은 종목끼리 정보 공유
- 더 강한 패턴 포착

## 현재 코드의 문제

### 원하는 구조
```
입력: [50종목, 80차원]
  ↓
상관관계 계산: 50×50 행렬
  ↓
그래프 구성: 종목1↔종목2, 종목1↔종목5, ...
  ↓
GAT 처리: 종목 간 정보 교환
```

### 실제 현재 코드
```
입력: [1종목, 80차원] ← 샘플 1개씩만!
  ↓
상관관계 계산: 1×1 행렬 ← 의미 없음
  ↓
그래프 구성: 종목1 ↔ ??? (연결할 종목 없음)
  ↓
GAT 처리: 정보 교환 불가능
```

## 해결 방법

### 월말별로 종목들을 함께 처리

```python
# 현재: 샘플을 쌓음
Xtr = [샘플1, 샘플2, ..., 샘플1000]
      (각 샘플은 종목 1개)

# 변경: 월말별로 종목 묶음
for each 월말:
    X_month = [종목1, 종목2, ..., 종목50]  # 50종목을 함께
      ↓
    상관관계 계산 (50×50 행렬 가능!)
      ↓
    그래프 구성 (종목 간 연결)
      ↓
    GAT 처리 (종목 간 정보 교환)
      ↓
    예측
```

## 상관관계가 활용되는 곳

### 1. 엣지 구성 (코드 522줄)
```python
adj = (correlation_matrix > self.corr_threshold).astype(np.float32)
```
- 상관관계 > 0.3 이면 연결
- 그렇지 않으면 연결 안함

### 2. 엣지 인덱스 변환 (코드 526줄)
```python
edge_index = self._correlation_to_edges(corr_matrix)
```
- [N, N] 행렬 → [2, E] 인덱스로 변환
- PyTorch Geometric 형식으로 변환

### 3. GAT 적용 (코드 647줄)
```python
h = self.model.gat1(node_features, edge_index)
```
- edge_index에 따라 정보 전파
- 상관관계 높은 종목끼리 더 많은 정보 교환

## 요약

**상관관계는:**
1. 종목 간 연결(edge)을 정의
2. GAT가 정보를 전파할 경로를 제공
3. 같은 산업/그룹의 종목들이 함께 학습됨

**하지만 현재는:**
- 샘플 1개씩만 처리해서 상관관계 계산 불가
- GAT의 장점을 살리지 못함

**해결:**
- 월말별로 모든 종목을 함께 묶어서 처리
- 그래야 진짜 그래프 구조를 만들 수 있음

